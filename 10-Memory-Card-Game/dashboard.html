<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #444;
    }
    #average, #cluster-counts {
      margin: 15px 0;
      font-weight: bold;
      text-align: center;
      font-size: 18px;
      color: #222;
    }
    #recommendation {
      margin-top: 20px;
      text-align: center;
      font-size: 18px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 6px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 12px 15px;
      text-align: center;
      font-size: 15px;
    }
    th {
      background-color: #6563FF;
      color: white;
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .cluster-0 {
      background-color: #d4edda !important;
    }
    .cluster-1 {
      background-color: #f8d7da !important;
    }
    .predicted-success {
      font-weight: bold;
      color: green;
    }
    .predicted-fail {
      font-weight: bold;
      color: red;
    }
    .back-button, .export-button {
      display: inline-block;
      margin: 15px 10px 0;
      padding: 10px 20px;
      background-color: #6563FF;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      border: none;
    }
    #filter-success {
      margin: 20px auto;
      display: block;
      max-width: 200px;
      font-size: 16px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h1>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h1>
  <p id="average">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
  <p id="cluster-counts"></p>

  <select id="filter-success">
    <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
    <option value="success">Ø§Ù„Ù†Ø§Ø¬Ø­ÙˆÙ† ÙÙ‚Ø·</option>
    <option value="fail">Ø§Ù„ÙØ§Ø´Ù„ÙˆÙ† ÙÙ‚Ø·</option>
  </select>

  <table>
    <thead>
      <tr>
        <th>Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª</th>
        <th>Ø§Ù„Ø²Ù…Ù† (Ø«ÙˆØ§Ù†ÙŠ)</th>
        <th>Ø§Ù„Ù†Ø¬Ø§Ø­</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©</th>
        <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
        <th>ØªÙˆÙ‚Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ</th>
      </tr>
    </thead>
    <tbody id="data-table"></tbody>
  </table>

  <div id="recommendation">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª...</div>

  <button class="export-button" id="export-csv">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ€ CSV</button>
  <a href="index.html" class="back-button">ğŸ”™ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

  <script>
    const tableBody = document.getElementById("data-table");
    const averageDisplay = document.getElementById("average");
    const recommendationBox = document.getElementById("recommendation");
    const filterSelect = document.getElementById("filter-success");
    const clusterCountsDisplay = document.getElementById("cluster-counts");
    const exportBtn = document.getElementById("export-csv");

    const data = JSON.parse(localStorage.getItem("playerStats")) || [];

    let totalMoves = 0;
    let totalTime = 0;

    function distance(p1, p2) {
      return Math.sqrt((p1[0] - p2[0])**2 + (p1[1] - p2[1])**2);
    }

    function kMeans(dataPoints, k = 2, maxIter = 10) {
      if (dataPoints.length === 0) return [];

      let centroids = [];
      for (let i = 0; i < k; i++) {
        centroids.push(dataPoints[Math.floor(Math.random() * dataPoints.length)]);
      }

      let assignments = new Array(dataPoints.length).fill(-1);

      for (let iter = 0; iter < maxIter; iter++) {
        let changed = false;
        for (let i = 0; i < dataPoints.length; i++) {
          let distances = centroids.map(c => distance(dataPoints[i], c));
          let minIndex = distances.indexOf(Math.min(...distances));
          if (assignments[i] !== minIndex) {
            assignments[i] = minIndex;
            changed = true;
          }
        }
        if (!changed) break;

        for (let j = 0; j < k; j++) {
          let clusterPoints = dataPoints.filter((_, idx) => assignments[idx] === j);
          if (clusterPoints.length === 0) continue;
          let meanX = clusterPoints.reduce((sum, p) => sum + p[0], 0) / clusterPoints.length;
          let meanY = clusterPoints.reduce((sum, p) => sum + p[1], 0) / clusterPoints.length;
          centroids[j] = [meanX, meanY];
        }
      }
      return assignments;
    }

    const points = data.map(p => [p.moves, p.timeTaken]);
    let clusters = points.length > 0 ? kMeans(points) : [];

    function renderTable(filter = "all") {
      tableBody.innerHTML = "";
      totalMoves = 0;
      totalTime = 0;
      let predictedSuccessCount = 0;
      let filteredData = [];

      // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      if(filter === "success") {
        filteredData = data.filter(p => p.success === 1);
      } else if(filter === "fail") {
        filteredData = data.filter(p => p.success === 0);
      } else {
        filteredData = [...data];
      }

      let clusterCounts = {0: 0, 1: 0};

      filteredData.forEach((player, i) => {
        const idx = data.indexOf(player);
        const clusterIndex = clusters[idx];
        clusterCounts[clusterIndex] = (clusterCounts[clusterIndex] || 0) + 1;

        const row = document.createElement("tr");
        const clusterName = clusterIndex === 0 ? "Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³Ø±ÙŠØ¹Ø©" : "Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø·ÙŠØ¦Ø©";
        row.classList.add(`cluster-${clusterIndex}`);

        const isLikelyToSucceed = player.moves < 50 && player.timeTaken < 60;
        const predictionText = isLikelyToSucceed ? "âœ” Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠÙ†Ø¬Ø­" : "âœ– Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠÙØ´Ù„";
        const predictionClass = isLikelyToSucceed ? "predicted-success" : "predicted-fail";
        if (isLikelyToSucceed) predictedSuccessCount++;

        const formattedDate = new Date(player.sessionTime).toLocaleDateString("ar-EG", {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'long',
          hour: '2-digit',
          minute: '2-digit'
        });

        row.innerHTML = `
          <td>${player.playerId}</td>
          <td>${player.moves}</td>
          <td>${player.timeTaken}</td>
          <td>${player.success === 1 ? "âœ”ï¸" : "âŒ"}</td>
          <td>${formattedDate}</td>
          <td>${clusterName}</td>
          <td class="${predictionClass}">${predictionText}</td>
        `;

        totalMoves += player.moves;
        totalTime += player.timeTaken;
        tableBody.appendChild(row);
      });

      if(filteredData.length > 0){
        const avgMoves = (totalMoves / filteredData.length).toFixed(2);
        const avgTime = (totalTime / filteredData.length).toFixed(2);
        averageDisplay.textContent = `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø±ÙƒØ§Øª: ${avgMoves} - Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆÙ‚Øª: ${avgTime} Ø«Ø§Ù†ÙŠØ©`;

        clusterCountsDisplay.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³Ø±ÙŠØ¹Ø©: ${clusterCounts[0] || 0} - ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø·ÙŠØ¦Ø©: ${clusterCounts[1] || 0}`;

        const successRate = (predictedSuccessCount / filteredData.length) * 100;
        let recommendation = "";

        if (successRate < 50) {
          recommendation = "ğŸ”§ Ø§Ù„ØªÙˆØµÙŠØ©: Ø§Ù„Ù„Ø¹Ø¨Ø© ØµØ¹Ø¨Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø¸Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø­Ø§ÙˆÙ„ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø£Ùˆ ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ§Øª.";
        } else if (successRate < 80) {
          recommendation = "ğŸ“ˆ Ø§Ù„ØªÙˆØµÙŠØ©: Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø£Ùˆ Ø¯Ø¹Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„.";
        } else {
          recommendation = "ğŸ‰ Ø§Ù„ØªÙˆØµÙŠØ©: Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²! Ø§Ø³ØªÙ…Ø± Ø¨Ù†ÙØ³ ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø³ØªÙˆÙ‰.";
        }

        recommendationBox.textContent = recommendation;
      } else {
        averageDisplay.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.";
        clusterCountsDisplay.textContent = "";
        recommendationBox.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª.";
      }
    }

    filterSelect.addEventListener("change", () => {
      renderTable(filterSelect.value);
    });

    function exportToCSV() {
      let csvContent = "Ø±Ù‚Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨,Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙƒØ§Øª,Ø§Ù„Ø²Ù…Ù† (Ø«ÙˆØ§Ù†ÙŠ),Ø§Ù„Ù†Ø¬Ø§Ø­,ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø³Ø©,Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©,ØªÙˆÙ‚Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ\n";
      data.forEach((player, i) => {
        const clusterIndex = clusters[i];
        const clusterName = clusterIndex === 0 ? "Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³Ø±ÙŠØ¹Ø©" : "Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨Ø·ÙŠØ¦Ø©";
        const isLikelyToSucceed = player.moves < 50 && player.timeTaken < 60;
        const predictionText = isLikelyToSucceed ? "Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠÙ†Ø¬Ø­" : "Ù…ØªÙˆÙ‚Ø¹ Ø£Ù† ÙŠÙØ´Ù„";
        const formattedDate = new Date(player.sessionTime).toLocaleString("ar-EG");

        csvContent += `${player.playerId},${player.moves},${player.timeTaken},${player.success === 1 ? "Ù†Ø¬Ø§Ø­" : "ÙØ´Ù„"},${formattedDate},${clusterName},${predictionText}\n`;
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "player_analysis.csv");
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    exportBtn.addEventListener("click", exportToCSV);

    // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    renderTable();

  </script>

</body>
</html>